<ng-container *transloco="let t">
  <div class="canvas">
    <div class="sidebar">
      <div class="workshops">
        <div class="top">
          <a>{{t('app.workshops')}}</a>
          <button biit-icon icon="plus" (click)="onAddWorkshop()"></button>
        </div>
        <div class="middle"
             mwlDroppable
             dragOverClass="drag-over">
          <div *ngFor="let workshop of filteredWorkshops"
               class="workshop"
               mwlDraggable
               [dropData]="{event: workshop}"
               [touchStartLongPress]="{ delay: 300, delta: 30 }"
               dragActiveClass="drag-active"
               [contextMenu]="workshopMenu"
               [contextMenuValue]="workshop"
          >
            <a class="duration">{{workshop.duration | timeDuration}}</a>
            <a class="title">{{workshop.title}}</a>
            <a class="speakers">{{workshop.speakers | userNameList: speakers}}</a>
          </div>
        </div>
        <div class="bottom">
          <biit-input-text [ngModel]="search"
                           (onActionPerformed)="search = $event;
                                                filterWorkshops();"
                           (focusout)="resetInputValue($event, search)"
                           icon="search"
                           [placeholder]="t('app.search')"
          ></biit-input-text>
        </div>
      </div>
      <biit-datepicker calendar-mode
                       class="mini-calendar"
                       [(ngModel)]="viewDate"
      ></biit-datepicker>
    </div>
    <div class="main">
      <div class="top">
        <div class="left">
          <a>
            {{viewDate | translocoDate: {month: 'long'} }}
            {{viewDate | translocoDate: {year: 'numeric'} }}
          </a>
          <button biit-icon icon="plus" (click)="onAddAppointment()"></button>
        </div>
        <div class="right">

        </div>
      </div>
      <biit-calendar [events]="events"
                     [viewDate]="viewDate"
                     [calendarMode]="CalendarMode.WEEK"
                     [gridContextMenu]="gridMenu"
                     [eventContextMenu]="eventMenu"
                     (onEventDrop)="onEventChange($event)"
                     (onEventClick)="mousePosition = $mouseEvent($event.sourceEvent); cardEvent = $event.event"
      ></biit-calendar>
    </div>
  </div>

  <biit-popup sixty-view closable
              *ngIf="targetEvent"
              (onClosed)="targetEvent = undefined; targetEventTemplate = undefined;"
              title="{{targetEvent.id ? t('app.edit_appointment') : t('app.create_appointment')}}"
  >
    <appointment-form [event]="targetEvent"
                      [template]="targetEventTemplate"
                      (onSaved)="targetEvent = undefined; targetEventTemplate = undefined; loadEvents();"
                      style="width: 100%"
    ></appointment-form>
  </biit-popup>

  <biit-popup sixty-view closable
              *ngIf="targetWorkshop"
              (onClosed)="targetWorkshop = undefined"
              title="{{targetWorkshop.id ? t('app.edit_workshop') : t('app.create_workshop')}}"
  >
    <workshop-form [workshop]="targetWorkshop"
                   (onSaved)="targetWorkshop = undefined;
                              onUpdateWorkshop($event);"
                   style="width: 100%"
    ></workshop-form>
  </biit-popup>

  <biit-popup closable no-header
              *ngIf="deleteEvent"
              (onClosed)="deleteEvent = undefined"
  >
    <div style="width: 100%; display: flex; align-items: center; flex-direction: column; gap: 2em;">
      <a>
        {{t('app.delete_appointment_confirm')}}
      </a>
      <div style="display: flex; gap: 3em">
        <button biit-button tertiary (click)="deleteEvent = undefined">
          {{t('app.cancel')}}
        </button>
        <button biit-button (click)="onDeleteAppointment()">
          {{t('app.delete')}}
        </button>
      </div>
    </div>
  </biit-popup>

  <biit-popup closable no-header
              *ngIf="deleteWorkshop"
              (onClosed)="deleteWorkshop = undefined"
  >
    <div style="width: 100%; display: flex; align-items: center; flex-direction: column; gap: 2em;">
      <a>
        {{t('app.delete_workshop_confirm')}}
      </a>
      <div style="display: flex; gap: 3em">
        <button biit-button tertiary (click)="deleteWorkshop = undefined">
          {{t('app.cancel')}}
        </button>
        <button biit-button (click)="onDeleteWorkshop()">
          {{t('app.delete')}}
        </button>
      </div>
    </div>
  </biit-popup>

  <context-menu #gridMenu>
    <ng-template contextMenuItem (execute)="onAddAppointment($event.value)">
      {{ t('app.create_appointment') }}
    </ng-template>
  </context-menu>

  <context-menu #eventMenu>
    <ng-template contextMenuItem (execute)="targetEvent = $event.value">
      {{ t('app.edit_appointment') }}
    </ng-template>
    <ng-template contextMenuItem (execute)="deleteEvent = $event.value">
      {{ t('app.delete_appointment') }}
    </ng-template>
  </context-menu>

  <context-menu #workshopMenu>
    <ng-template contextMenuItem (execute)="targetWorkshop = $event.value">
      {{ t('app.edit_workshop') }}
    </ng-template>
    <ng-template contextMenuItem (execute)="deleteWorkshop = $event.value">
      {{ t('app.delete_workshop') }}
    </ng-template>
  </context-menu>

  <event-card *ngIf="cardEvent"
              class="event-card"
              [style.top]="mousePosition?.y + 10 + 'px'"
              [style.left]="(mousePosition?.x - 11.75*16) + 'px'"
              [event]="cardEvent"
              [speakers]="speakers"
              (onEdit)="targetEvent = cardEvent; cardEvent = undefined;"
              (onClosed)="cardEvent = undefined"
  ></event-card>
</ng-container>
